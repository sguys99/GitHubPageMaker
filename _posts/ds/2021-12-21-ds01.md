---
layout: post
current: post
cover: 'assets/images/2021-12-21-ds1/ds01.00.jpg'
navigation: True
title: custom datasetìœ¼ë¡œ YOLOv5 í•™ìŠµí•˜ê¸°-1
date: 2021-12-21 13:30:00
tags: data-science
class: post-template
subclass: 'post'
author: km.yu99
---

{% include yolo-table-of-contents.html %}

YOLO(You Only Look Once)ëŠ” ë„ë¦¬ ì“°ì´ëŠ” object detection ì•Œê³ ë¦¬ì¦˜ì´ë‹¤. ìµœê·¼ì—ëŠ” YOLOv5 ê¹Œì§€ ì¶œì‹œë˜ì—ˆë‹¤. ì—¬ê¸°ì„œëŠ” ê³µì‹ github ê³„ì •ì— ì—…ë¡œë“œëœ YOLOv5 ì½”ë“œë¡œ custom datasetì„ í•™ìŠµí•˜ëŠ” ë°©ë²•ì— ëŒ€í•˜ì—¬ ì„¤ëª…í•œë‹¤. google colab í™˜ê²½ì—ì„œ ì§„í–‰ë˜ì—ˆë‹¤.



### 1. ë°ì´í„°ì…‹ ì†Œê°œ

ì‹¤ìŠµì— ì‚¬ìš©ë˜ëŠ” ë°ì´í„°ì…‹ì€ `roboflow`ì—ì„œ ì œê³µë˜ëŠ” `North American Mushrooms Dataset`ì´ë‹¤.[[ë§í¬]](https://public.roboflow.com/object-detection)  

<img src="assets/images/2021-12-21-ds1/ds01.01.jpg">


ì—¬ê¸°ì„œëŠ” í•™ìŠµì‹œê°„ì„ ì¤„ì´ê¸° ìœ„í•´ì„œ 416x416 ì‚¬ì´ì¦ˆì˜ ì´ë¯¸ì§€ 51ì¥ì„ ë‹¤ìš´ ë°›ì•˜ë‹¤.

<img src="assets/images/2021-12-21-ds1/ds01.02.jpg">

object detection ì•Œê³ ë¦¬ì¦˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ êµ¬í˜„ë°©ì‹ì— ë”°ë¼, ê·¸ë¦¬ê³  YOLO ë²„ì „ ë³„ë¡œë„ ì‚¬ìš©í•˜ëŠ” ë ˆì´ë¸”ë§ íŒŒì¼ì˜ í¬ë§·ì´ ë‹¤ë¥´ë‹¤. `roboflow`ì—ì„œëŠ” ë ˆì´ë¸”ë§ íŒŒì¼ í¬ë§·ì„ ì„ íƒí•˜ì—¬ ë‹¤ìš´ë„ë¥´ í•  ìˆ˜ ìˆë‹¤. ìš°ë¦¬ëŠ” PyTorchë¡œ êµ¬í˜„ëœ ê³µì‹ ê³„ì •ì˜ ì½”ë“œë¥¼ ì‚¬ìš©í•  ì˜ˆì •ì´ë¯€ë¡œ `YOLO v5 PyTorch`ë¥¼ ì„ íƒí•˜ê³  ë‹¤ìš´ë¡œë“œ í•œë‹¤.

<img src="assets/images/2021-12-21-ds1/ds01.03.jpg">

ì°¸ê³ ë¡œ YOLOv5 ê³µì‹ê³„ì •ì˜ ì½”ë“œëŠ” `txt` í¬ë§·ì˜ ë ˆì´ë¸”ë§ ë°ì´í„°ë¥¼ ì‚¬ìš©í•œë‹¤.
ì´ íŒŒì¼ì€ ì´ë¯¸ì§€ì—ì„œ ê²€ì¶œëœ objectì— ëŒ€í•œ í´ë˜ìŠ¤ì™€ bounding box ì •ë³´ë¥¼ í¬í•¨í•˜ê³  ìˆë‹¤. ê²€ì¶œ ê°ì²´ì •ë³´ ë°°ì¹˜ëŠ” `[class, x_center, y_center, width, height]` í˜•íƒœë¡œ ë˜ì–´ìˆë‹¤. bounding box ì •ë³´ëŠ” ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆì— ì˜í•´ ì •ê·œí™” ë˜ì–´ìˆë‹¤. ë”°ë¼ì„œ 0~1 ë²”ìœ„ì˜ ê°’ì„ ê°€ì§„ë‹¤.

<img src="assets/images/2021-12-21-ds1/ds01.04.jpg">


í¸ì˜ë¥¼ ìœ„í•´ ë‹¤ìš´ë¡œë“œí•œ ë°ì´í„° ì…‹ ì••ì¶•íŒŒì¼ì˜ í´ë” ì´ë¦„ì„ `custom_dataset`ìœ¼ë¡œ ìˆ˜ì •í•œë‹¤. ë°ì´í„° í´ë” êµ¬ì„±ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

```
custom_dataset
â”‚
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ images/                    
â”‚   â””â”€â”€ labels/             
â”‚
â”œâ”€â”€ train/
â”‚   â”œâ”€â”€ images/                
â”‚   â””â”€â”€ labels/               
â”‚
â”œâ”€â”€ valid/
â”‚   â”œâ”€â”€ images/                    
â”‚   â””â”€â”€ labels/   
â”‚
â”œâ”€â”€ data.yaml
â””â”€â”€ README.dataset.txt
```

`data.yaml`íŒŒì¼ì„ ë©”ëª¨ì¥ìœ¼ë¡œ ì—´ì–´ë³´ì. ë°ì´í„° ì…‹ ê¸°ë³¸ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆë‹¤. `ìš°ë¦¬ëŠ” *.yaml` íŒŒì¼ì„ ìƒˆë¡œ ë§Œë“¤ ê²ƒì´ë‹¤. ì–´ë–¤ ì‹ìœ¼ë¡œ êµ¬ì„±ë˜ëŠ”ì§€ ì°¸ê³ ë§Œ í•œë‹¤.

<img src="assets/images/2021-12-21-ds1/ds01.05.jpg">

`train`ê³¼ `val`ì€ ê° ë°ì´í„° ì…‹ì˜ ê²½ë¡œì •ë³´ì´ë‹¤. ê·¸ë¦¬ê³  ncëŠ” classì˜ ìˆ˜(number of classes)ë¥¼, namesëŠ” ê° í´ë˜ìŠ¤ì˜ ì´ë¦„ì´ë‹¤. 



### 2. colabì—ì„œ í™˜ê²½êµ¬ì¶•í•˜ê¸°

google colabì— ì ‘ì†í•˜ê³  ìƒˆ ë…¸íŠ¸ë¥¼ ìƒì„±í•œë‹¤. `ëŸ°íƒ€ì„`-`ëŸ°íƒ€ì„ ìœ í˜• ë³€ê²½`ì„ ì„ íƒí•˜ì—¬, í•˜ë“œì›¨ì–´ ê°€ì†ê¸°ë¥¼ `GPU`ë¡œ ì„¤ì •í•œë‹¤.

<img src="assets/images/2021-12-21-ds1/ds01.06.jpg">


ì´ì œ colab ë…¸íŠ¸ì— ê³µì‹ github ê³„ì •ì˜ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ê³ , í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•˜ëŠ” ëª…ë ¹ì„ ì…ë ¥í•œë‹¤.

```python
!git clone https://github.com/ultralytics/yolov5  # yolov5 ì½”ë“œ clone
%cd yolov5 										  # cloneí•œ í´ë”ë¡œ ì§„ì…
%pip install -qr requirements.txt                 # í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
```

```
Cloning into 'yolov5'...
remote: Enumerating objects: 10354, done.
remote: Total 10354 (delta 0), reused 0 (delta 0), pack-reused 10354
Receiving objects: 100% (10354/10354), 10.58 MiB | 23.75 MiB/s, done.
Resolving deltas: 100% (7149/7149), done.
/content/yolov5
     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 596 kB 5.4 MB/s 
```



íŒŒì¼ íƒìƒ‰ê¸°ì— yolov5 í´ë”ê°€ ìƒì„±ë˜ì—ˆê³ , íŒŒì¼ë“¤ì´ ë‹¤ìš´ë¡œë“œ ë˜ì–´ìˆë‹¤.

<img src="assets/images/2021-12-21-ds1/ds01.07.jpg">


ì´ì œ ì•ì—ì„œ ë‹¤ìš´ë¡œë“œí•œ ë°ì´í„°ì…‹ì„ ì—…ë¡œë“œ í•œë‹¤. íŒŒì¼ íƒìƒ‰ê¸°ì˜ ì—…ë¡œë“œ ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬ `custom_dataset.zip` íŒŒì¼ì„ ì—…ë¡œë“œ í•œë‹¤.
ì—…ë¡œë“œê°€ ì™„ë£Œë˜ë©´ íƒìƒ‰ê¸°ì— í•´ë‹¹ íŒŒì¼ì´ í‘œì‹œëœë‹¤.

<img src="assets/images/2021-12-21-ds1/ds01.08.jpg">

unzip ëª…ë ¹ìœ¼ë¡œ ë°ì´í„° ì…‹ íŒŒì¼ì˜ ì••ì¶•ì„ í•´ì œí•œë‹¤.

```python
!unzip ../custom_dataset.zip
```

```
Archive:  ../custom_dataset.zip
  inflating: custom_dataset/data.yaml  
  inflating: custom_dataset/README.dataset.txt  
  inflating: custom_dataset/README.roboflow.txt  
   creating: custom_dataset/test/
   creating: custom_dataset/test/images/
  inflating: custom_dataset/test/images/chanterelle_02_jpg.rf.f7a48494b7393c532f641585d99a57be.jpg  
  inflating: custom_dataset/test/images/chanterelle_03_jpg.rf.580f8d787af6a8050c21c065bf016f20.jpg  
  inflating: custom_dataset/test/images/chanterelle_03_jpg.rf.cd892d2f06d228ba20d194fc360320fc.jpg  
  --- (ìƒ ëµ)
```



ì™„ë£Œë˜ë©´ `yolov5/custom_dataset/` ê²½ë¡œì— ë°ì´í„° ì…‹ì´ ìœ„ì¹˜í•˜ê²Œ ëœë‹¤. (í˜„ ì‘ì—… ë””ë ‰í† ë¦¬ê°€ yolov5ì´ê¸° ë•Œë¬¸)

<img src="assets/images/2021-12-21-ds1/ds01.09.jpg">


ë§ˆì§€ë§‰ìœ¼ë¡œ ë°ì´í„° ì…‹ ì„¤ì •íŒŒì¼ì„ ì‘ì„±í•œë‹¤.

` yolov5/data/` í´ë”ì— `custom_dataset.yaml`ì´ë¼ëŠ” ì´ë¦„ì˜ íŒŒì¼ì„ ìƒì„±í•œë‹¤.

<img src="assets/images/2021-12-21-ds1/ds01.10.jpg">

ì—¬ê¸°ì— ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •ì •ë³´ë¥¼ ì…ë ¥í•œë‹¤.

```
path: /content/yolov5/custom_dataset  #root ë””ë ‰í† ë¦¬
train: train/images					  # í•™ìŠµë°ì´í„° ê²½ë¡œ
val: valid/images
test: test/images

nc: 2								# í´ë˜ìŠ¤ ìˆ˜
names: ['CoW', 'chanterelle']		# í´ë˜ìŠ¤ ì´ë¦„
```

ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒ [ë§í¬](https://github.com/ultralytics/yolov5/wiki/Train-Custom-Data)ì˜ `**1.1 Create dataset.yaml**` í•­ëª©ì„ ì°¸ê³ í•˜ì.



ì´ë¡œì¨ í•™ìŠµì„ ìœ„í•œ ëª¨ë“  ì¤€ë¹„ê°€ ì™„ë£Œ ë˜ì—ˆë‹¤.



### 3. ëª¨ë¸ í•™ìŠµí•˜ê¸°

ëª¨ë¸ í•™ìŠµ ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

<img src="assets/images/2021-12-21-ds1/ds01.11.jpg">

ìœ„ì™€ ê°™ì€ ì¼ë ¨ì˜ ê³¼ì •ì€ `train.py`  íŒŒì¼ ì‹¤í–‰ì„ í†µí•´ ê°€ëŠ¥í•˜ë‹¤. ì¸ìë¡œ í•™ìŠµ ë°ì´í„° ê²½ë¡œì™€ epoch ìˆ˜ë¥¼ ì…ë ¥í•˜ê³  í•™ìŠµì„ ì§„í–‰í•˜ì.

```python
!python train.py --data "data/custom_dataset.yaml" --epochs 100 #epoch 100íšŒ
```

 ```
 Downloading https://ultralytics.com/assets/Arial.ttf to /root/.config/Ultralytics/Arial.ttf...
 train: weights=yolov5s.pt, cfg=, data=data/custom_dataset.yaml, hyp=data/hyps/hyp.scratch.yaml, epochs=100, batch_size=16, imgsz=640, '''
 
 ---(ìƒëµ)
 
 Overriding model.yaml nc=80 with nc=2
 
                  from  n    params  module                                  arguments                     
   0                -1  1      3520  models.common.Conv                      [3, 32, 6, 2, 2]              
   1                -1  1     18560  models.common.Conv                      [32, 64, 3, 2]                
   2                -1  1     18816  models.common.C3                        [64, 64, 1]
   
 ---(ìƒëµ)
 
 Logging results to runs/train/exp
 Starting training for 100 epochs...
 
      Epoch   gpu_mem       box       obj       cls    labels  img_size
       0/99     3.23G    0.1252   0.03226   0.02699        28       640: 100% 3/3 [00:05<00:00,  1.95s/it]
                Class     Images     Labels          P          R     mAP@.5 mAP@.5:.95: 100% 1/1 [00:00<00:00,  2.48it/s]
                  all          5         14    0.00695      0.311    0.00395     0.0011
       
 ---(ìƒëµ)
 
 Validating runs/train/exp/weights/best.pt...
 Fusing layers... 
 Model Summary: 213 layers, 7015519 parameters, 0 gradients, 15.8 GFLOPs
                Class     Images     Labels          P          R     mAP@.5 mAP@.5:.95: 100% 1/1 [00:00<00:00,  4.48it/s]
                  all          5         14       0.95      0.996      0.973      0.697
                  CoW          5          5          1      0.991      0.995      0.688
          chanterelle          5          9      0.899          1      0.951      0.706
 Results saved to runs/train/exp
 ```



í•™ìŠµì´ ì™„ë£Œë˜ë©´ `runs/train/exp`ê²½ë¡œì— í•™ìŠµ ê²°ê³¼ê°€ ì €ì¥ëœë‹¤. í•™ìŠµì„ ë°˜ë³µí•˜ë©´ `runs/train`ê²½ë¡œì— exp1, 2, 3... ê°™ì€ í˜•íƒœë¡œ í´ë”ê°€ ìƒì„±ë˜ë©´ì„œ í•™ìŠµ ê²°ê³¼ê°€ ê¸°ë¡ëœë‹¤. 

<img src="assets/images/2021-12-21-ds1/ds01.12.jpg">

í•™ìŠµ ê²°ê³¼ë¥¼ ë‹¤ìš´ë¡œë“œ í•˜ê³  ì‹¶ë‹¤ë©´ zip ëª…ë ¹ì„ ì••ì¶•í•œ ë’¤, ì €ì¥í•œë‹¤ . ì˜ˆë¥¼ ë“¤ì–´ `train_result.zip`ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì••ì¶•í•˜ê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì…ë ¥í•œë‹¤.

```python
!zip -r train_result.zip /content/yolov5/runs/train/exp
```



íƒìƒ‰ê¸°ì— `train_result.zip`ê°€ í‘œì‹œë˜ë©´ ì •ìƒìœ¼ë¡œ ì••ì¶•ëœ ê²ƒì´ë‹¤.

<img src="assets/images/2021-12-21-ds1/ds01.13.jpg">


### 4. í•™ìŠµí•œ ëª¨ë¸ ê²€ì¦í•˜ê¸°

ì´ì œ í•™ìŠµí•œ ëª¨ë¸ë¡œ ê²€ì¦ì„ ì§„í–‰í•´ë³´ì. ê²€ì¦ìˆœì„œëŠ” ì•ì˜ í•™ìŠµ ì ˆì°¨ì—ì„œ `ëª¨ë¸ ê°€ì¤‘ì¹˜ ì—…ë°ì´íŠ¸` ê³¼ì •ì´ ìƒëµëœ ê²ƒì´ë‹¤.

<img src="assets/images/2021-12-21-ds1/ds01.14.jpg">

ëª¨ë¸ ê²€ì¦ì€ `val.py`  íŒŒì¼ ì‹¤í–‰ì„ í†µí•´ ì§„í–‰í•œë‹¤. ë‹¤ì–‘í•œ ì¸ìê°€ ìˆì§€ë§Œ ë°ì´í„° ê²½ë¡œ(`--data`), ëª¨ë¸ ê°€ì¤‘ì¹˜(`--weights`) ì •ë„ë§Œ ì…ë ¥í•´ì„œ ì‹¤í–‰í•´ë³´ì. ì•ì—ì„œ í•™ìŠµí•œ ëª¨ë¸ ê°€ì¤‘ì¹˜ëŠ” `runs/train/exp/weights/best.pt`ì— ì €ì¥ë˜ì—ˆë‹¤.

```python
!python val.py --data "data/custom_dataset.yaml" --weights "/content/yolov5/runs/train/exp/weights/best.pt"
```

```
val: data=data/custom_dataset.yaml, weights=['/content/yolov5/runs/train/exp/weights/best.pt'], batch_size=32, imgsz=640, conf_thres=0.001, iou_thres=0.6, task=val, device=, workers=8, single_cls=False, augment=False, verbose=False, save_txt=False, save_hybrid=False, save_conf=False, save_json=False, project=runs/val, name=exp, exist_ok=False, half=False, dnn=False
YOLOv5 ğŸš€ v6.0-155-gdc54ed5 torch 1.10.0+cu111 CUDA:0 (Tesla K80, 11441MiB)

Fusing layers... 
Model Summary: 213 layers, 7015519 parameters, 0 gradients, 15.8 GFLOPs
val: Scanning '/content/yolov5/custom_dataset/valid/labels.cache' images and labels... 5 found, 0 missing, 0 empty, 0 corrupted: 100% 5/5 [00:00<?, ?it/s]
               Class     Images     Labels          P          R     mAP@.5 mAP@.5:.95: 100% 1/1 [00:00<00:00,  2.58it/s]
                 all          5         14      0.909      0.982      0.961      0.686
                 CoW          5          5          1      0.965      0.995      0.672
         chanterelle          5          9      0.818          1      0.926        0.7
Speed: 0.6ms pre-process, 29.3ms inference, 3.0ms NMS per image at shape (32, 3, 640, 640)
Results saved to runs/val/exp
```



ê²€ì¦ê²°ê³¼ëŠ” `runs/val/exp`ì— ì €ì¥ëœë‹¤. ì•ì—ì„œì™€ ë§ˆì°¬ê°€ì§€ë¡œ ë‹¤ìš´ë¡œë“œ ë°›ê³  ì‹¶ë‹¤ë©´ í´ë”ë¥¼ ì••ì¶•í•˜ì.

```python
!zip -r val_result.zip /content/yolov5/runs/val
```

`exp` í´ë” ì•ˆì—ëŠ” confusion matrix, F1 curve ë“± ì„±ëŠ¥ê³¼ ê´€ë ¨ëœ ì°¨íŠ¸ê°€ ì €ì¥ë˜ì–´ ìˆë‹¤.



### 5. í•™ìŠµí•œ ëª¨ë¸ë¡œ ì˜ˆì¸¡í•˜ê¸°

ì˜ˆì¸¡ê³¼ì •ì€ ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì€ ì ˆì°¨ë¡œ ì§„í–‰ëœë‹¤.

<img src="assets/images/2021-12-21-ds1/ds01.15.jpg">

ì˜ˆì¸¡ ê³¼ì •ì€ `detect.py` íŒŒì¼ì„ ì‚¬ìš©í•œë‹¤. ë‹¨ìˆœ ì´ë¯¸ì§€ ë¿ë§Œ ì•„ë‹ˆë¼ ì›¹ìº , ë¹„ë””ì˜¤ íŒŒì¼ ë“±ì—ì„œë„ ì‹¤í–‰ ê°€ëŠ¥í•˜ë‹¤. `--source`ì¸ìì— ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•´ì£¼ë©´ ëœë‹¤.

```
!python detect.py --source 0  # webcam
                            img.jpg  # image
                            vid.mp4  # video
                            path/  # directory
                            path/*.jpg  # glob
                            'https://youtu.be/Zgi9g1ksQHc'  # YouTube
                            'rtsp://example.com/media.mp4'  # RTSP, RTMP, HTTP stream
```



ì—¬ê¸°ì„œëŠ” `custom_dataset/test/images` ê²½ë¡œì— ìˆëŠ” ì´ë¯¸ì§€ì— ëŒ€í•´ì„œ object detectionì„ ì‹¤í–‰í•´ë³¸ë‹¤. ì¸ì‹ ëŒ€ìƒ (`--source`), ëª¨ë¸ ê°€ì¤‘ì¹˜(`--weights`)  ê²½ë¡œë¥¼ ì…ë ¥í•´ì„œ ì‹¤í–‰í•´ë³´ì.

```python
!python detect.py --weights "/content/yolov5/runs/train/exp/weights/best.pt" --source "/content/yolov5/custom_dataset/test/images"
```

```
detect: weights=['/content/yolov5/runs/train/exp/weights/best.pt'], source=/content/yolov5/custom_dataset/test/images, imgsz=[640, 640], conf_thres=0.25, iou_thres=0.45, max_det=1000, device=, view_img=False, save_txt=False, save_conf=False, 

---(ìƒëµ)

Fusing layers... 
Model Summary: 213 layers, 7015519 parameters, 0 gradients, 15.8 GFLOPs
image 1/5 /content/yolov5/custom_dataset/test/images/chanterelle_02_jpg.rf.f7a48494b7393c532f641585d99a57be.jpg: 640x640 3 chanterelles, Done. (0.034s)
--- (ìƒëµ)
```



í…ŒìŠ¤íŠ¸ ê²°ê³¼ëŠ” `/runs/detect/exp` ê²½ë¡œì— ì €ì¥ëœë‹¤. ê²°ê³¼ë¥¼ ë‹¤ìš´ë¡œë“œ í•˜ê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì••ì¶•í•˜ì—¬ ì €ì¥í•œë‹¤.

```python
!zip -r test_result.zip /content/yolov5/runs/detect/exp
```

í´ë”ë¥¼ ì—´ì–´ë³´ë©´ classì™€ bounding boxê°€ í‘œì‹œëœ detection ê²°ê³¼ ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì–´ ìˆë‹¤.

<img src="assets/images/2021-12-21-ds1/ds01.16.jpg">