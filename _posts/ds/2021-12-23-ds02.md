---
layout: post
current: post
cover: 'assets/images/2021-12-21-ds1/ds01.00.jpg'
navigation: True
title: custom datasetìœ¼ë¡œ YOLOv5 í•™ìŠµí•˜ê¸°2
date: 2021-12-21 13:30:00
tags: data-science
class: post-template
subclass: 'post'
author: km.yu99
---

{% include yolo-table-of-contents.html %}

ì´ì „ í¬ìŠ¤íŠ¸ì—ì„œ custom datasetìœ¼ë¡œ YOLOv5 ëª¨ë¸ì„ í•™ìŠµì‹œí‚¤ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì„¤ëª…í•˜ì˜€ë‹¤. ì—¬ê¸°ì„œëŠ” í•™ìŠµê³¼ ê´€ë ¨ëœ íŒŒë¼ë¯¸í„°ë¥¼ ì¡°ì •í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì„¤ëª…í•œë‹¤. ì•ì—ì„œì™€ ë§ˆì°¬ê°€ì§€ë¡œ ì‹¤ìŠµí™˜ê²½ì€ google colabì´ë‹¤.



### 1. ë°ì´í„°ì…‹ ì†Œê°œ

ì‹¤ìŠµì— ì‚¬ìš©ë˜ëŠ” ë°ì´í„°ì…‹ì€ `roboflow`ì—ì„œ ì œê³µë˜ëŠ” `Mask Wearking Dataset`(raw)ì´ë‹¤.[[ë§í¬]](https://public.roboflow.com/object-detection/mask-wearing/4)   

(rawì™€ 416x416ìœ¼ë¡œ ë³€í™˜ëœ ë°ì´í„°ì…‹ì„ ì„ íƒí•  ìˆ˜ ìˆëŠ”ë°, ì—¬ê¸°ì„œëŠ” raw ë°ì´í„°ì…‹ì„ ì‚¬ìš©í•œë‹¤.)

<img src="assets/images/2021-12-23-ds2/ds02.01.jpg">



### 2. colabì—ì„œ í™˜ê²½êµ¬ì¶•í•˜ê¸°

í™˜ê²½êµ¬ì¶•ì€ ì•ê³¼ ê°™ê¸° ë•Œë¬¸ì— ê°„ë ¥í•˜ê²Œ ì„¤ëª…í•œë‹¤. ìƒì„¸í•œ ë‚´ìš©ì€ ì´ì „ í¬ìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•œë‹¤. [[ë§í¬]](https://sguys99.github.io/ds1)   

- google colabì— ì ‘ì†í•˜ê³  ìƒˆ ë…¸íŠ¸ë¥¼ ìƒì„± 
- `ëŸ°íƒ€ì„`-`ëŸ°íƒ€ì„ ìœ í˜• ë³€ê²½`ì„ ì„ íƒí›„, ê°€ì†ê¸°ë¥¼ `GPU`ë¡œ ì„¤ì •

- yolov5 íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œ ë° í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜

```python
!git clone https://github.com/ultralytics/yolov5  # yolov5 ì½”ë“œ clone
%cd yolov5 										  # cloneí•œ í´ë”ë¡œ ì§„ì…
%pip install -qr requirements.txt                 # í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
```

- custom dataset ì—…ë¡œë“œ (ì—¬ê¸°ì„œëŠ” `mask_dataset.zip` ìœ¼ë¡œ ì„¤ëª…)

- ë°ì´í„° ì…‹ íŒŒì¼ ì••ì¶• í•´ì œ

```python
!unzip ../custom_dataset.zip
```

- ` yolov5/data/` í´ë”ì— `mask_dataset.yaml`íŒŒì¼ ì‘ì„±

```
path: /content/yolov5/mask_dataset
train: train/images
val: valid/images
test: test/images

nc: 2
names: ['mask', 'no-mask']
```



### 3. í•™ìŠµ íŒŒë¼ë¯¸í„° ì‚´í´ë³´ê¸°

ì´ì œ í•™ìŠµí•  ë•Œ íŒŒë¼ë¯¸í„°ë¥¼ ì¡°ì •í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì„¤ëª…í•œë‹¤.

ëª¨ë¸ì„ í•™ìŠµí•  ë•Œ ë‹¤ìŒê³¼ ê°™ì´ ë°ì´í„°ì…‹ ê´€ë ¨ ê²½ë¡œë§Œ ì…ë ¥í•˜ë©´ ê°€ëŠ¥í•˜ë‹¤.

```python
!python train.py --data "ë°ì´í„°ì…‹.yaml íŒŒì¼ ê²½ë¡œ"
```



ë‚˜ë¨¸ì§€ íŒŒë¼ë¯¸í„°ë“¤ì€ ë””í„íŠ¸ ê°’ìœ¼ë¡œ ëŒ€ì²´ëœë‹¤. ê·¸ëŸ¬ë©´ í•™ìŠµê³¼ ê´€ë ¨ëœ íŒŒë¼ë¯¸í„°ì—ëŠ” ì–´ë–¤ ê²ƒë“¤ì´ ìˆì„ê¹Œ? yolov5 í´ë” ì•ˆì— ìˆëŠ” train.py íŒŒì¼ì„ ì—´ì–´ì„œ 440ë²ˆì§¸ ë¼ì¸ ë¶€ê·¼ì— ìˆëŠ” `parse_opt` í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ì. ì•„ë˜ì™€ ê°™ì´ íŒŒë¼ë¯¸í„°ë“¤ì´ ì •ì˜ë˜ì–´ ìˆë‹¤.

```python
def parse_opt(known=False):
    parser = argparse.ArgumentParser()
    parser.add_argument('--weights', type=str, default=ROOT / 'yolov5s.pt', help='initial weights path')
    parser.add_argument('--cfg', type=str, default='', help='model.yaml path')
    parser.add_argument('--data', type=str, default=ROOT / 'data/coco128.yaml', help='dataset.yaml path')
    parser.add_argument('--hyp', type=str, default=ROOT / 'data/hyps/hyp.scratch.yaml', help='hyperparameters path')
    parser.add_argument('--epochs', type=int, default=300)
    parser.add_argument('--batch-size', type=int, default=16, help='total batch size for all GPUs, -1 for autobatch')
    parser.add_argument('--imgsz', '--img', '--img-size', type=int, default=640, help='train, val image size (pixels)')
    parser.add_argument('--rect', action='store_true', help='rectangular training')
    
    --- (ìƒ ëµ)
```



í•™ìŠµê³¼ ê´€ë ¨ëœ íŒŒë¼ë¯¸í„°ê°€ 40ì—¬ê°œë‚˜ ëœë‹¤. í•˜ì§€ë§Œ ëª¨ë‘ ì•Œ í•„ìš”ëŠ” ì—†ë‹¤. ëª¨ë¸ ì„±ëŠ¥ì´ë‚˜ í•˜ë“œì›¨ì–´ ìì›ê³¼ ê´€ë ¨ëœ ì¤‘ìš”í•œ íŒŒë¼ë¯¸í„°ë§Œ ì‚´í´ë³´ì.   



- **ëª¨ë¸êµ¬ì¡° (--weights)** 

ëª¨ë¸ êµ¬ì¡°ì™€ ê´€ë ¨ëœ íŒŒë¼ë¯¸í„°ì´ë‹¤. YOLOv5ëŠ” ë‹¤ì–‘í•œ ëª¨ë¸ êµ¬ì¡°ë¥¼ ì œê³µí•œë‹¤. default ê°’ì€ `YOLOv5`ë¡œ êµ¬ì¡°ê°€ ì œì¼ ê°„ë‹¨í•˜ë‹¤. ëª¨ë¸ì˜ êµ¬ì¡°ê°€ ë” ë³µì¡í•œ ê²ƒìœ¼ë¡œ `YOLOv5m`, `YOLOv5l`, `YOLOv5x` ì´ ìˆë‹¤. 

<img src="assets/images/2021-12-23-ds2/ds02.02.jpg">

êµ¬ì¡°ê°€ ë³µì¡í•  ìˆ˜ë¡ ì„±ëŠ¥ì´ ë†’ì•„ì§ˆ ê°€ëŠ¥ì„±ì€ ë†’ì§€ë§Œ í•™ìŠµí•  ë•Œ ë” ë§ì€ ì‹œê°„ì´ ì†Œìš”ë˜ê³  ë§ì€ ë¦¬ì†ŒìŠ¤ê°€ ìš”êµ¬ëœë‹¤. ì˜ˆë¥¼ ë“¤ì–´ yolov5m ëª¨ë¸ì„ í•™ìŠµì‹œí‚¤ê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì…ë ¥í•˜ë©´ ëœë‹¤.

```python
--weights "yolov5m.pt"
```

ê³µì‹ githubì—ëŠ” ì´ì™¸ì— ìƒˆë¡œìš´ ëª¨ë¸ êµ¬ì¡°ê°€ ì§€ì†ì ìœ¼ë¡œ ì—…ë¡œë“œë˜ê³  ìˆë‹¤. [[ë§í¬]](https://github.com/ultralytics/yolov5/releases)



- **ë°°ì¹˜ ì‚¬ì´ì¦ˆ (--batch-size)** 

í•™ìŠµí•  ë•Œ í•œë²ˆì— ì²˜ë¦¬í•  ì´ë¯¸ì§€ ìˆ˜(batch-size)ë¥¼ ì§€ì •í•  ìˆ˜ ìˆë‹¤. defaultëŠ” 16ì´ë‹¤. batch sizeë¥¼ 32ë¡œ ì…ë ¥í•˜ê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì˜µì…˜ ì„¤ì •ì„ í•˜ë©´ëœë‹¤.

```python
--batch-size 32
```



- **ì´ë¯¸ì§€ í¬ê¸° (--imgsz,  --img, --img-size)**

YOLOv5ëŠ” í•™ìŠµí•  ë•Œ ëª¨ë“  ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆë¥¼ ë™ì¼í•˜ê²Œ resizing í•œë‹¤. default ì‚¬ì´ì¦ˆëŠ” 640x640ì´ë‹¤. ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆë¥¼ í¬ê²Œ ì„¤ì •í• ìˆ˜ë¡ ëª¨ë¸ ì„±ëŠ¥ì€ ë” ì¢‹ì•„ì‹¤ ìˆ˜ ìˆë‹¤. í•˜ì§€ë§Œ í•™ìŠµì†ë„ì™€ ë¦¬ì†ŒìŠ¤ ë¶€ë‹´ì€ ë” ì»¤ì§€ê²Œ ëœë‹¤. ì´ë¯¸ì§€ í¬ê¸°ë¥¼ 1280x1280ìœ¼ë¡œ ì„¤ì •í•˜ê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì…ë ¥í•œë‹¤.

```python
--imgsz(or --img or --img-size) 1280
```

**ê²€ì¦ì´ë‚˜ ì‹œí—˜í•  ë•Œ í•™ìŠµì— ì‚¬ìš©í•œ ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆì™€ ë™ì¼í•˜ê²Œ ì„¤ì •í•´ì•¼í•œë‹¤.**



- **ì—í¬í¬ ìˆ˜ (--epochs)**

ë°ì´í„°ì…‹ìœ¼ë¡œ í•™ìŠµì„ ë°˜ë³µí•  íšŸìˆ˜ë¥¼ ì§€ì •í•˜ëŠ” ì—í¬í¬ì˜ default ê°’ì€ 300ì´ë‹¤. 100ìœ¼ë¡œ ì„¤ì •í•˜ê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì…ë ¥í•œë‹¤.

```python
--epochs 100
```



- **í•˜ì´í¼ íŒŒë¼ë¯¸í„° (--hyp)**

í•˜ì´í¼ íŒŒë¼ë¯¸í„°ê°€ ì •ì˜ë˜ì–´ ìˆëŠ” ê²½ë¡œë¥¼ ì§€ì •í•œë‹¤. default ê°’ì€ `data/hyps/hyp.scratch.yaml`ì´ë‹¤. í•´ë‹¹ ê²½ë¡œì˜ íŒŒì¼ì„ ì—´ì–´ í™•ì¸í•´ë³´ì.



### 4. íŒŒë¼ë¯¸í„°ë¥¼ ì¡°ì •í•˜ì—¬ ëª¨ë¸ í•™ìŠµí•˜ê¸°

colabì—ì„œ ì œê³µí•˜ëŠ” ìì›ì„ ìµœëŒ€í•œ ì‚¬ìš©í•˜ì—¬ í•™ìŠµì„ ì§„í–‰í•´ë³´ì. ëª¨ë¸ êµ¬ì¡°ëŠ” `yolov5m.pt`, ì…ë ¥ ì´ë¯¸ì§€ í¬ê¸°ëŠ” `1280`, ë°°ì¹˜ ì‚¬ì´ì¦ˆëŠ” 8, ì—í¬í¬ ìˆ˜ëŠ” 60ìœ¼ë¡œ ì„¤ì •í•´ë³´ì. (ëª¨ë¸ êµ¬ì¡°ê°€ ì»¤ì§€ê³  ì…ë ¥ ì´ë¯¸ì§€ê°€ ë³µì¡í•´ì ¸ì„œ colab gpu í•œê³„ë¥¼ ë§ì¶”ê¸° ìœ„í•´ ë°°ì¹˜ ì‚¬ì´ì¦ˆì™€ í•™ìŠµì‹œê°„ì„ ì¤„ì—¬ì•¼ë§Œ í–ˆë‹¤.)

```python
!python train.py --data "data/mask_dataset.yaml" --batch-size 8 --img 1280 --weights "yolov5m.pt" --epochs 60
```

```
train: weights=yolov5m.pt, cfg=, data=data/mask_dataset.yaml, hyp=data/hyps/hyp.scratch.yaml, epochs=60, batch_size=8, imgsz=1280, rect=False, 

--(ìƒ ëµ)

hyperparameters: lr0=0.01, lrf=0.1, momentum=0.937, weight_decay=0.0005, warmup_epochs=3.0, warmup_momentum=0.8, warmup_bias_lr=0.1, box=0.05, cls=0.5, 
--(ìƒ ëµ)
                 from  n    params  module                                  arguments                     
  0                -1  1      5280  models.common.Conv                      [3, 48, 6, 2, 2]              
  1                -1  1     41664  models.common.Conv                      [48, 96, 3, 2]                
  2                -1  2     65280  models.common.C3                        [96, 96, 2] 
  
--(ìƒ ëµ)

Model Summary: 290 layers, 20856975 parameters, 0 gradients, 48.0 GFLOPs
               Class     Images     Labels          P          R     mAP@.5 mAP@.5:.95: 100% 2/2 [00:06<00:00,  3.12s/it]
                 all         29        162       0.81      0.853      0.861      0.531
                mask         29        142      0.871      0.805      0.888      0.559
             no-mask         29         20       0.75        0.9      0.835      0.503
Results saved to runs/train/exp3
```

ì—¬ê¸°ì„œëŠ” í•™ìŠµ ê²°ê³¼ê°€ `/runs/train/exp3`ì— ì €ì¥ë˜ì—ˆë‹¤. ì‚¬ìš©ì ë§ˆë‹¤ ì €ì¥ìœ„ì¹˜ê°€ ë‹¤ë¥¼ ê²ƒì´ë‹¤.



### 5. ê²€ì¦í•˜ê¸°

ê²€ì¦ê³¼ ê´€ë ¨ëœ íŒŒë¼ë¯¸í„°ëŠ” `val.py` íŒŒì¼ì˜ 306ë²ˆì§¸ ë¼ì¸ì˜ `parse_opt` í•¨ìˆ˜ì— ì •ì˜ë˜ì–´ ìˆë‹¤.

í•™ìŠµí•  ë•Œ ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆëŠ” 1280ìœ¼ë¡œ ì„¤ì •í•˜ì˜€ê³ , ëª¨ë¸ ê°€ì¤‘ì¹˜ëŠ” `/runs/train/exp3/weights/best.pt` ì €ì¥ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë‹¤ìŒê³¼ ê°™ì´ ì…ë ¥í•˜ì—¬ ê²€ì¦ì„ ì§„í–‰í•˜ì.

```
!python val.py --data "data/mask_dataset.yaml" --img 1280 --weights "/content/yolov5/runs/train/exp3/weights/best.pt"
```

```
val: data=data/mask_dataset.yaml, weights=['/content/yolov5/runs/train/exp3/weights/best.pt'], batch_size=32, imgsz=1280, conf_thres=0.001, iou_thres=0.6, task=val, device=, workers=8, single_cls=False, augment=False, verbose=False, save_txt=False, save_hybrid=False, save_conf=False, save_json=False, project=runs/val, name=exp, exist_ok=False, half=False, dnn=False
YOLOv5 ğŸš€ v6.0-159-gdb6ec66 torch 1.10.0+cu111 CUDA:0 (Tesla K80, 11441MiB)

Fusing layers... 
Model Summary: 290 layers, 20856975 parameters, 0 gradients, 48.0 GFLOPs
val: Scanning '/content/yolov5/mask_dataset/valid/labels.cache' images and labels... 29 found, 0 missing, 0 empty, 0 corrupted: 100% 29/29 [00:00<?, ?it/s]
               Class     Images     Labels          P          R     mAP@.5 mAP@.5:.95: 100% 1/1 [00:08<00:00,  8.05s/it]
                 all         29        162      0.813      0.851      0.862      0.535
                mask         29        142      0.878       0.81      0.887      0.556
             no-mask         29         20      0.748      0.892      0.837      0.514
Speed: 1.5ms pre-process, 166.8ms inference, 4.4ms NMS per image at shape (32, 3, 1280, 1280)
Results saved to runs/val/exp
```

ì˜ˆì¸¡ê²°ê³¼ê°€ `runs/val/exp`ì— ì €ì¥ë˜ì—ˆë‹¤.



### 6. ì˜ˆì¸¡í•˜ê¸°

ì˜ˆì¸¡í•  ë•ŒëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë¸ì˜ ê²½ë¡œ(--weights), ì…ë ¥ ë°ì´í„° ê²½ë¡œ(--source)ë¥¼ ì§€ì •í•´ì¤˜ì•¼ í•œë‹¤. ì—¬ê¸°ì— ì¶”ê°€ë¡œ ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆ(--img)ë„ ì§€ì •í•´ì£¼ì.

```python
!python detect.py --img 1280 --weights "/content/yolov5/runs/train/exp3/weights/best.pt" --source "/content/yolov5/mask_dataset/test/images"
```

```
detect: weights=['/content/yolov5/runs/train/exp3/weights/best.pt'], source=/content/yolov5/mask_dataset/test/images, imgsz=[1280, 1280], conf_thres=0.25, 

---(ìƒ ëµ)

Results saved to runs/detect/exp
```

`runs/detect/exp`ì— ì˜ˆì¸¡ ê²°ê³¼ê°€ ì €ì¥ëœë‹¤.

<img src="assets/images/2021-12-23-ds2/ds02.03.jpg">



**ì°¸ ê³  :** ê¸°íšŒê°€ ë˜ë©´ confidence threshold(`--conf-thres`)ì™€ IoU threshold(`--iou-thres`) ë„ ë³€ê²½í•´ê°€ë©° ì˜ˆì¸¡ê²°ê³¼ë¥¼ ë¹„êµí•´ë³´ì.

